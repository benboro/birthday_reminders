---
phase: 01-contact-import-and-birthday-list
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - BirthdayReminders/Views/BirthdayList/BirthdayListView.swift
  - BirthdayReminders/Views/BirthdayList/BirthdayRowView.swift
  - BirthdayReminders/Views/BirthdayList/BirthdayDetailView.swift
  - BirthdayReminders/Views/Components/EmptyStateView.swift
  - BirthdayReminders/Views/Components/SettingsPlaceholderView.swift
  - BirthdayReminders/ContactsUIBridge/ContactDetailBridge.swift
  - BirthdayReminders/App/BirthdayRemindersApp.swift
autonomous: false

must_haves:
  truths:
    - "User sees upcoming birthdays sorted nearest-first with sections: today, this week, this month, later (LIST-01)"
    - "Today's birthdays have a highlighted row with distinct background color (user decision)"
    - "User can search contacts by name with always-visible search bar (LIST-02)"
    - "User can tap a birthday to see detail view with name, birthday date, and days until (LIST-03)"
    - "Detail view has 'Open in Contacts' link to edit birthday in iOS Contacts (user decision)"
    - "User can manually re-import contacts via a button (user decision: manual re-import)"
    - "Settings accessible via gear icon in navigation bar (user decision)"
    - "Empty state shown when no contacts imported yet"
    - "App makes zero network requests (SECR-01)"
  artifacts:
    - path: "BirthdayReminders/Views/BirthdayList/BirthdayListView.swift"
      provides: "Main list with sections, search, navigation, re-import button"
      contains: ".searchable"
    - path: "BirthdayReminders/Views/BirthdayList/BirthdayRowView.swift"
      provides: "Single row: name, formatted birthday date, days until, highlighted if today"
      contains: "BirthdayRowView"
    - path: "BirthdayReminders/Views/BirthdayList/BirthdayDetailView.swift"
      provides: "Detail: name, birthday date, days until, Open in Contacts"
      contains: "BirthdayDetailView"
    - path: "BirthdayReminders/ContactsUIBridge/ContactDetailBridge.swift"
      provides: "UIViewControllerRepresentable wrapping CNContactViewController"
      contains: "CNContactViewController"
    - path: "BirthdayReminders/Views/Components/EmptyStateView.swift"
      provides: "Guidance when no birthdays found"
      contains: "EmptyStateView"
    - path: "BirthdayReminders/Views/Components/SettingsPlaceholderView.swift"
      provides: "Settings stub with re-import button (gear icon destination)"
      contains: "SettingsPlaceholderView"
  key_links:
    - from: "BirthdayReminders/Views/BirthdayList/BirthdayListView.swift"
      to: "BirthdayReminders/Models/Person.swift"
      via: "@Query fetches all Person, sorted in-memory by daysUntilBirthday"
      pattern: "@Query.*Person"
    - from: "BirthdayReminders/Views/BirthdayList/BirthdayListView.swift"
      to: "BirthdayReminders/Services/BirthdayCalculator.swift"
      via: "Groups people into sections via BirthdayCalculator.section()"
      pattern: "BirthdayCalculator\\.section"
    - from: "BirthdayReminders/Views/BirthdayList/BirthdayDetailView.swift"
      to: "BirthdayReminders/ContactsUIBridge/ContactDetailBridge.swift"
      via: "'Open in Contacts' button presents ContactDetailBridge"
      pattern: "ContactDetailBridge"
    - from: "BirthdayReminders/App/BirthdayRemindersApp.swift"
      to: "BirthdayReminders/Views/BirthdayList/BirthdayListView.swift"
      via: "Main screen after onboarding complete"
      pattern: "BirthdayListView"
---

<objective>
Build the birthday list UI (main screen with sectioned list, search, today highlighting), detail view with "Open in Contacts", empty state, settings placeholder with re-import, and the CNContactViewController bridge. Wire everything into the app's navigation.

Purpose: This plan delivers the primary user-facing experience -- the birthday list that the user interacts with daily. It completes all LIST requirements and provides the manual re-import capability.
Output: Fully functional birthday list app with search, sections, detail view, and re-import.
</objective>

<execution_context>
@C:/Users/bmbor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/bmbor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contact-import-and-birthday-list/01-CONTEXT.md
@.planning/phases/01-contact-import-and-birthday-list/01-RESEARCH.md
@.planning/phases/01-contact-import-and-birthday-list/01-01-SUMMARY.md
@.planning/phases/01-contact-import-and-birthday-list/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BirthdayListView with sections, search, and BirthdayRowView</name>
  <files>
    BirthdayReminders/Views/BirthdayList/BirthdayListView.swift
    BirthdayReminders/Views/BirthdayList/BirthdayRowView.swift
    BirthdayReminders/Views/Components/EmptyStateView.swift
    BirthdayReminders/Views/Components/SettingsPlaceholderView.swift
  </files>
  <action>
    **BirthdayListView.swift** -- Main screen per research Pattern 6:

    1. Fetch all Person records using `@Query private var allPeople: [Person]` (sort by birthdayMonth as a rough ordering; real sort is in-memory).

    2. **Search:** `@State private var searchText = ""`. Apply `.searchable(text: $searchText, placement: .navigationBarDrawer(displayMode: .always), prompt: "Search contacts")` -- search bar always visible at top (user decision).

    3. **Filtering:** Computed `filteredPeople: [Person]` -- if searchText is empty, return all; otherwise filter by `displayName.localizedCaseInsensitiveContains(searchText)`.

    4. **Sectioned sorting:** Computed `sections: [(BirthdaySection, [Person])]`:
       - Group filteredPeople by `BirthdayCalculator.section(for: person.daysUntilBirthday)`
       - For each BirthdaySection in BirthdaySection.allCases order, collect matching people sorted by daysUntilBirthday ascending
       - Skip empty sections (compactMap)
       - This is in-memory sort (research: @Query cannot sort computed properties, in-memory is fine for < 1000 contacts)

    5. **List body:** NavigationStack containing a List with ForEach over sections:
       - `Section(section.rawValue)` for each section -- sticky headers are default List behavior in .plain style (discretion: sticky per research recommendation)
       - Inside each section: ForEach over people, each wrapped in `NavigationLink(value: person)` showing BirthdayRowView
       - `.navigationDestination(for: Person.self)` presenting BirthdayDetailView

    6. **Navigation bar:**
       - `.navigationTitle("Birthdays")`
       - `.toolbar` with trailing gear icon (`Image(systemName: "gear")`) that navigates to SettingsPlaceholderView
       - No tab bar (user decision: single screen with navigation bar)

    7. **Empty state:** If allPeople is empty (no contacts imported), show EmptyStateView instead of the list.

    **BirthdayRowView.swift** -- Single row:
    - Receives a `Person` instance
    - Displays: `person.displayName` (primary text), formatted birthday via `BirthdayCalculator.formattedBirthday(month:day:year:)` (secondary text), days until as badge/trailing text ("Today", "Tomorrow", "3 days", etc.)
    - Minimal: name + date + days until only -- NO photos, NO age (user decision)
    - **Today highlighting:** If `person.daysUntilBirthday == 0`, apply a distinct background color or accent to make the row stand out (user decision). Use a subtle system color like `Color.accentColor.opacity(0.1)` for the row background, or a small colored indicator. Must be visible in both light and dark mode.
    - Format days-until text: 0 = "Today", 1 = "Tomorrow", N = "in N days"

    **EmptyStateView.swift:**
    - Centered view with a friendly message: "No Birthdays Yet"
    - Brief guidance: "Import your contacts to see upcoming birthdays."
    - Optional: a button to trigger re-import (or direct to Settings)
    - System styling, works in light and dark mode

    **SettingsPlaceholderView.swift:**
    - Destination for the gear icon in the navigation bar
    - Title: "Settings"
    - Contains a "Re-import Contacts" button that triggers `syncService.importContacts(into: context)`
    - Shows a ProgressView while importing
    - Shows last import count or status after completion
    - This is a stub for Phase 2 which will add notification settings here
    - Inject ContactSyncService from environment or pass as parameter

    IMPORTANT: Do NOT use @Query sort on computed properties like nextBirthdayDate or daysUntilBirthday -- fetch all and sort in-memory (research anti-pattern).
    IMPORTANT: Search bar must be always visible, not hidden under scroll (user decision).
    IMPORTANT: No photos, no age, no zodiac in rows (user decision: minimal rows).
    IMPORTANT: Today's birthdays MUST have visual distinction (user decision: highlighted row).
  </action>
  <verify>
    - BirthdayListView uses @Query for Person, sorts in-memory by daysUntilBirthday
    - .searchable with displayMode: .always is present
    - Sections are created from BirthdaySection.allCases in order
    - BirthdayRowView shows name, formatted date, and days-until text
    - BirthdayRowView applies visual highlight when daysUntilBirthday == 0
    - EmptyStateView exists with guidance text
    - SettingsPlaceholderView has re-import button connected to ContactSyncService
    - No photos, age, or zodiac in BirthdayRowView
    - Gear icon in navigation toolbar
    - No tab bar anywhere
  </verify>
  <done>
    Birthday list displays contacts in four sections (today, this week, this month, later) sorted nearest-first. Search bar is always visible and filters by name. Today's birthdays are visually highlighted. Empty state guides users when no contacts imported. Settings placeholder provides manual re-import. All styling follows iOS-native patterns with system colors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement BirthdayDetailView, ContactDetailBridge, and wire app navigation</name>
  <files>
    BirthdayReminders/Views/BirthdayList/BirthdayDetailView.swift
    BirthdayReminders/ContactsUIBridge/ContactDetailBridge.swift
    BirthdayReminders/App/BirthdayRemindersApp.swift
  </files>
  <action>
    **BirthdayDetailView.swift** -- Detail screen:

    1. Receives a `Person` instance
    2. Displays:
       - Name (person.displayName) prominently at top
       - Birthday date formatted via BirthdayCalculator.formattedBirthday(month:day:year:)
       - Days until next birthday: "Today!", "Tomorrow", "in N days"
       - No age, no zodiac (user decision: basics only)
    3. "Open in Contacts" button/link:
       - Uses a `.sheet` or `.fullScreenCover` to present ContactDetailBridge with the person's contactIdentifier
       - Alternatively, present as a NavigationLink or button that opens the bridge
       - Label: "Open in Contacts" with a system icon (e.g., `person.crop.circle` or `arrow.up.forward.app`)
    4. Read-only view -- no call, message, or other quick actions (user decision)
    5. Push transition (discretion: research recommends push for content views, standard NavigationStack behavior)
    6. Style: iOS-native, system fonts, system colors. Light/dark mode compatible.
    7. Layout: Clean, centered or leading-aligned, with generous spacing. Exact layout is Claude's discretion.

    **ContactDetailBridge.swift** -- UIViewControllerRepresentable per research code example:

    1. Takes `contactIdentifier: String` as parameter
    2. In `makeUIViewController`:
       - Create CNContactStore and fetch the contact with `store.unifiedContact(withIdentifier:keysToFetch:)` using `CNContactViewController.descriptorForRequiredKeys()`
       - If contact not found (deleted since import), show an empty UINavigationController or handle gracefully
       - Create `CNContactViewController(for: contact)`
       - Set `allowsEditing = true` (user can edit birthday in Contacts -- it is the single source of truth)
       - Set `allowsActions = false` (no call/message actions per user decision: read-only, no quick actions)
       - Wrap in UINavigationController and return
    3. `updateUIViewController` -- no-op (static content)
    4. Add a `Coordinator` if needed to handle the CNContactViewController delegate (dismiss on done)

    **Update BirthdayRemindersApp.swift** -- Final wiring:

    1. Replace the placeholder birthday list reference with the real BirthdayListView
    2. Ensure the routing logic is:
       - `hasCompletedOnboarding == false` -> OnboardingFlowView
       - `hasCompletedOnboarding == true` -> NavigationStack with BirthdayListView
    3. Ensure ContactSyncService is created as @State in the App and passed/injected to both onboarding and list views
    4. The NavigationStack should be at this level so BirthdayListView can push to BirthdayDetailView and SettingsPlaceholderView
    5. Verify ModelContainer is injected via .modelContainer(container) on the WindowGroup

    IMPORTANT: No quick actions (call, message) in detail view (user decision: read-only).
    IMPORTANT: "Open in Contacts" must use CNContactViewController via UIViewControllerRepresentable -- no custom URL schemes.
    IMPORTANT: allowsActions = false on CNContactViewController (user decision: no call/message actions).
    IMPORTANT: Person model must conform to Hashable for NavigationLink(value:) to work. SwiftData @Model types are Hashable by default, but verify.
  </action>
  <verify>
    - BirthdayDetailView shows name, formatted birthday, days until
    - BirthdayDetailView has "Open in Contacts" button that presents ContactDetailBridge
    - BirthdayDetailView has NO call/message/age/zodiac content
    - ContactDetailBridge uses CNContactViewController with allowsActions = false
    - ContactDetailBridge fetches contact using CNContactViewController.descriptorForRequiredKeys()
    - BirthdayRemindersApp routes correctly: onboarding when not completed, list when completed
    - NavigationStack wraps the list and supports push to detail and settings
    - ModelContainer injected at WindowGroup level
  </verify>
  <done>
    Detail view shows name, birthday, and days-until with "Open in Contacts" link using CNContactViewController bridge. App navigation fully wired: onboarding on first launch, birthday list after completion, push to detail view, push to settings. All Phase 1 requirements (IMPT-01, IMPT-02, LIST-01, LIST-02, LIST-03, SECR-01 through SECR-04) are implemented.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 app on device</name>
  <files>
    BirthdayReminders/App/BirthdayRemindersApp.swift
  </files>
  <action>
    Human verification of the complete Phase 1 app built across all three plans. Build and deploy to iPhone via MacinCloud/Xcode, then verify all flows described below. No code changes expected -- this is a verification-only checkpoint.
  </action>
  <verify>
    Build and run on MacinCloud via Xcode, deploy to iPhone:

    1. First launch - onboarding flow:
       - App opens to welcome screen with app explanation
       - Tap "Get Started" then pre-permission screen explains why access is needed
       - Tap "Allow Access" then system permission dialog appears
       - Grant access then import progress shown then transitions to birthday list

    2. Birthday list:
       - Contacts with birthdays appear in sections (today, this week, this month, later)
       - Sorted nearest-first within each section
       - If any contact has a birthday today, their row should be visually highlighted
       - Search bar is visible at top without scrolling
       - Type a name and list filters in real time

    3. Detail view:
       - Tap any birthday and detail view shows name, birthday date, days until
       - No age, photos, or zodiac shown
       - "Open in Contacts" button opens the contact in iOS Contacts editor
       - Back swipe returns to list

    4. Settings / Re-import:
       - Tap gear icon in navigation bar and see settings screen
       - Tap "Re-import Contacts" and contacts refresh from Contacts store

    5. Visual checks:
       - Light mode and dark mode both look correct (toggle in Settings then Display)
       - System blue accent color used throughout
       - iOS-native feel: standard fonts, controls, navigation

    6. Security spot check:
       - In Xcode: Instruments Network profiler shows zero app-initiated requests
       - No third-party frameworks in Build Phases then Link Binary With Libraries
  </verify>
  <done>
    All Phase 1 flows verified on device: onboarding completes successfully, birthday list shows sections with search and today highlighting, detail view works with "Open in Contacts", re-import works, light/dark mode correct, zero network activity confirmed. User types "approved" to confirm.
  </done>
</task>

</tasks>

<verification>
- All Phase 1 requirements covered:
  - IMPT-01: One-tap import via onboarding and re-import button
  - IMPT-02: Pre-permission screen with contextual explanation
  - LIST-01: Sections (today, this week, this month, later) sorted nearest-first
  - LIST-02: Search by name with always-visible search bar
  - LIST-03: Detail view with name, birthday date, days until
  - SECR-01: Zero networking imports across all files
  - SECR-02: Data Protection entitlement set to NSFileProtectionComplete + SwiftData
  - SECR-03: Zero third-party dependencies
  - SECR-04: All contact data logged with privacy: .private
- User decisions all honored:
  - Manual re-import (not continuous sync)
  - Guided onboarding (welcome -> permission -> import)
  - Minimal rows (name + date + days until, no photos, no age)
  - Today highlighting (distinct background)
  - Always-visible search bar
  - Detail: basics only, read-only, "Open in Contacts"
  - iOS-native feel, light/dark mode, system blue accent
  - Single screen with nav bar, gear icon for settings, no tab bar
  - Permission denied: explanation + open Settings
</verification>

<success_criteria>
User can open the app, complete onboarding, see their contacts with birthdays in a sectioned list, search by name, tap to see details, open a contact in iOS Contacts, and re-import via settings. The app looks and feels native iOS, supports light and dark mode, and satisfies all four security requirements. All Phase 1 success criteria from ROADMAP.md are met.
</success_criteria>

<output>
After completion, create `.planning/phases/01-contact-import-and-birthday-list/01-03-SUMMARY.md`
</output>
