---
phase: 01-contact-import-and-birthday-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - BirthdayReminders/App/BirthdayRemindersApp.swift
  - BirthdayReminders/Models/Person.swift
  - BirthdayReminders/Models/ContactBridge.swift
  - BirthdayReminders/Services/BirthdayCalculator.swift
  - BirthdayReminders/Extensions/Date+Birthday.swift
  - BirthdayReminders/Extensions/Logger+App.swift
  - BirthdayReminders/BirthdayReminders.entitlements
  - BirthdayReminders/Info.plist
  - BirthdayReminders.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "Xcode project compiles with zero third-party dependencies (SECR-03)"
    - "Person model stores decomposed birthday fields (month, day, optional year, optional calendarId) in SwiftData"
    - "BirthdayCalculator correctly computes next birthday and days-until for normal dates, Feb 29 in non-leap years (maps to March 1), and nil-year contacts"
    - "ContactBridge maps CNContact to Person with upsert logic and handles both Gregorian and non-Gregorian birthdays"
    - "App Group container is configured in ModelConfiguration for Phase 4 widget compatibility"
    - "Data Protection entitlement is set to NSFileProtectionComplete (SECR-02)"
  artifacts:
    - path: "BirthdayReminders/Models/Person.swift"
      provides: "SwiftData @Model with decomposed birthday, contactIdentifier unique constraint, displayName computed property"
      contains: "@Model"
    - path: "BirthdayReminders/Services/BirthdayCalculator.swift"
      provides: "Pure functions: nextBirthday, daysUntil, formattedBirthday, section categorization"
      contains: "enum BirthdayCalculator"
    - path: "BirthdayReminders/Models/ContactBridge.swift"
      provides: "CNContact-to-Person mapping, keysToFetch, upsert, removeStale, resolveBirthday"
      contains: "struct ContactBridge"
    - path: "BirthdayReminders/App/BirthdayRemindersApp.swift"
      provides: "@main app entry with ModelContainer using App Group"
      contains: "groupContainer"
    - path: "BirthdayReminders/Extensions/Logger+App.swift"
      provides: "Privacy-safe os.Logger extensions"
      contains: "Logger"
  key_links:
    - from: "BirthdayReminders/Models/Person.swift"
      to: "BirthdayReminders/Services/BirthdayCalculator.swift"
      via: "Computed properties call BirthdayCalculator static methods"
      pattern: "BirthdayCalculator\\.(nextBirthday|daysUntil)"
    - from: "BirthdayReminders/Models/ContactBridge.swift"
      to: "BirthdayReminders/Models/Person.swift"
      via: "Creates and updates Person instances from CNContact"
      pattern: "Person\\("
    - from: "BirthdayReminders/App/BirthdayRemindersApp.swift"
      to: "BirthdayReminders/Models/Person.swift"
      via: "ModelContainer schema includes Person"
      pattern: "Person\\.self"
---

<objective>
Create the Xcode project skeleton and implement the entire data foundation: Person model with decomposed birthday fields in SwiftData, BirthdayCalculator with pure date math (including Feb 29 handling), ContactBridge for CNContact-to-Person mapping, and App/entitlement configuration with App Group and Data Protection from day one.

Purpose: Establishes the project structure and all data logic that every subsequent plan depends on. Models and calculators are pure logic with no UI dependencies, making them the ideal starting point per research recommendation.
Output: Compilable Xcode project with working data layer, ready for service and UI layers.
</objective>

<execution_context>
@C:/Users/bmbor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/bmbor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contact-import-and-birthday-list/01-CONTEXT.md
@.planning/phases/01-contact-import-and-birthday-list/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode project structure with entitlements and App Group configuration</name>
  <files>
    BirthdayReminders/App/BirthdayRemindersApp.swift
    BirthdayReminders/BirthdayReminders.entitlements
    BirthdayReminders/Info.plist
    BirthdayReminders/Extensions/Logger+App.swift
    BirthdayReminders.xcodeproj/project.pbxproj
  </files>
  <action>
    Create the complete Xcode project directory structure following the architecture from research:

    ```
    BirthdayReminders/
      App/
      Models/
      Services/
      Views/
        Onboarding/
        BirthdayList/
        Components/
      Extensions/
      ContactsUIBridge/
      Resources/
        Assets.xcassets/
    ```

    1. **BirthdayRemindersApp.swift** -- The @main entry point. Create a ModelContainer with ModelConfiguration using `groupContainer: .identifier("group.com.birthdayreminders")`. The schema should include `Person.self`. Handle container creation failure with `fatalError` (as research recommends). For now, the body should show a placeholder ContentView -- later plans will wire up the real onboarding/list flow.

    2. **BirthdayReminders.entitlements** -- Add:
       - `com.apple.security.application-groups` array with `group.com.birthdayreminders`
       - `com.apple.developer.default-data-protection` string with `NSFileProtectionComplete`

    3. **Info.plist** -- Add:
       - `NSContactsUsageDescription`: "Birthday Reminders needs access to your contacts to find birthdays and remind you about them."
       - Standard bundle identifiers

    4. **Logger+App.swift** -- Create os.Logger extensions per research pattern:
       - `Logger.app` (subsystem: "com.birthdayreminders", category: "app")
       - `Logger.sync` (subsystem: "com.birthdayreminders", category: "sync")
       All contact data must use `privacy: .private` per SECR-04.

    5. **Xcode project file (project.pbxproj)** -- Generate a valid Xcode project file that:
       - Targets iOS 18.0+
       - Includes all source files in the correct groups
       - Sets PRODUCT_BUNDLE_IDENTIFIER to com.birthdayreminders
       - Links no third-party frameworks (SECR-03) -- only system frameworks: SwiftUI, SwiftData, Contacts, ContactsUI, os
       - Sets CODE_SIGN_ENTITLEMENTS to the entitlements file
       - Enables Data Protection capability
       - Enables App Groups capability

    Note on project file: Creating a valid .pbxproj by hand is extremely complex. Instead, create a `Package.swift` or use `xcodegen` approach: create a `project.yml` for XcodeGen that the user can run on MacinCloud to generate the .xcodeproj. If neither is practical, create all Swift source files with correct imports and a README explaining the one-time Xcode project creation steps (File > New Project > App, then add files and capabilities). The priority is getting all source code correct -- the project file can be created interactively on MacinCloud.

    IMPORTANT: Do NOT import URLSession, Network.framework, or any networking APIs anywhere (SECR-01). Do NOT include any third-party SPM packages (SECR-03).
  </action>
  <verify>
    - All directories and files exist at expected paths
    - BirthdayRemindersApp.swift contains `groupContainer` configuration
    - Entitlements file contains both App Groups and Data Protection entries
    - Info.plist contains NSContactsUsageDescription
    - Logger+App.swift uses `privacy: .private` for all string interpolations
    - No file imports URLSession or Network
    - Grep all .swift files for "import" to confirm only Apple first-party frameworks
  </verify>
  <done>
    Project structure exists with all directories, entitlements configured for App Group + Data Protection, Info.plist has contact usage description, Logger extensions use privacy-safe patterns, and zero networking or third-party imports anywhere.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Person model, BirthdayCalculator, and ContactBridge</name>
  <files>
    BirthdayReminders/Models/Person.swift
    BirthdayReminders/Services/BirthdayCalculator.swift
    BirthdayReminders/Models/ContactBridge.swift
    BirthdayReminders/Extensions/Date+Birthday.swift
  </files>
  <action>
    1. **Person.swift** -- SwiftData @Model per research Pattern 1:
       - `@Attribute(.unique) var contactIdentifier: String`
       - `var firstName: String`, `var lastName: String`
       - `var birthdayMonth: Int` (1-12), `var birthdayDay: Int` (1-31)
       - `var birthdayYear: Int?` (nil when contact has no year)
       - `var birthdayCalendarId: String?` (nil = Gregorian)
       - Computed `displayName: String` -- joins firstName and lastName, handles empty components
       - Computed `nextBirthdayDate: Date` -- delegates to `BirthdayCalculator.nextBirthday(month:day:)`
       - Computed `daysUntilBirthday: Int` -- delegates to `BirthdayCalculator.daysUntil(month:day:)`
       - Computed `birthdaySection: BirthdaySection` -- delegates to `BirthdayCalculator.section(for:)`
       - Make Person conform to `Identifiable` (SwiftData models are automatically, but be explicit)
       - Do NOT store DateComponents directly (research anti-pattern). Decompose to Int fields.

    2. **BirthdayCalculator.swift** -- Pure stateless enum per research Pattern 5:
       - `static func nextBirthday(month: Int, day: Int, from referenceDate: Date = .now) -> Date`
         - Try birthday in current year first; if it has already passed, use next year
         - Feb 29 handling: if month==2 && day==29 and the target year is NOT a leap year, use March 1 of that year instead
         - Check leap year by verifying if day 29 exists in February of the target year via Calendar.range(of:in:for:)
       - `static func daysUntil(month: Int, day: Int, from referenceDate: Date = .now) -> Int`
         - Uses `nextBirthday()` and computes calendar day difference from start-of-day today
       - `static func formattedBirthday(month: Int, day: Int, year: Int?) -> String`
         - Year present: "March 15, 1990" format
         - Year nil: "March 15" format
         - Use DateFormatter (not FormatStyle) for explicit control
       - `static func section(for daysUntil: Int) -> BirthdaySection`
         - 0 -> .today, 1-7 -> .thisWeek, 8-30 -> .thisMonth, 31+ -> .later
       - `enum BirthdaySection: String, CaseIterable, Identifiable` with cases: today, thisWeek, thisMonth, later
         - Raw values: "Today", "This Week", "This Month", "Later"
         - `var id: String { rawValue }`

    3. **ContactBridge.swift** -- Stateless struct per research Pattern 4:
       - `static func keysToFetch() -> [CNKeyDescriptor]` -- single canonical list:
         CNContactIdentifierKey, CNContactGivenNameKey, CNContactFamilyNameKey,
         CNContactBirthdayKey, CNContactNonGregorianBirthdayKey,
         CNContactViewController.descriptorForRequiredKeys()
       - `static func upsert(from contact: CNContact, into context: ModelContext)` -- per research:
         Call resolveBirthday(); if nil, skip contact. Fetch existing by contactIdentifier using FetchDescriptor with #Predicate. Update if exists, insert if new.
       - `static func resolveBirthday(from contact: CNContact) -> (month: Int, day: Int, year: Int?, calendarId: String?)?`
         - Prefer Gregorian: contact.birthday with month and day
         - Fall back to non-Gregorian: contact.nonGregorianBirthday, convert via its calendar to Gregorian month/day
         - Return nil if neither has month+day
       - `static func removeStale(knownIdentifiers: Set<String>, context: ModelContext)` -- fetch all Person, delete those whose contactIdentifier is not in the known set
       - Use Logger.sync with `privacy: .private` for any contact name logging (SECR-04)

    4. **Date+Birthday.swift** -- Minimal Date helpers if needed by BirthdayCalculator. At minimum, add a `startOfDay` convenience if not using Calendar directly everywhere. Keep this thin -- most logic belongs in BirthdayCalculator.

    IMPORTANT: Do NOT use @Query sort on computed properties (research anti-pattern). The list view will fetch all and sort in-memory.
    IMPORTANT: Feb 29 birthdays MUST map to March 1 in non-leap years -- this is a locked policy from research.
    IMPORTANT: Non-Gregorian birthdays MUST be handled via resolveBirthday fallback.
  </action>
  <verify>
    - Person.swift contains `@Model`, `@Attribute(.unique)` on contactIdentifier, all five birthday fields, computed properties delegating to BirthdayCalculator
    - BirthdayCalculator.swift contains all four static methods, BirthdaySection enum, and Feb 29 leap year check
    - ContactBridge.swift contains keysToFetch with all required keys including CNContactViewController.descriptorForRequiredKeys(), upsert with FetchDescriptor, resolveBirthday with non-Gregorian fallback, removeStale
    - No file imports URLSession or Network
    - All Logger usage in ContactBridge uses `privacy: .private` for contact data
  </verify>
  <done>
    Person model stores decomposed birthday as Int fields with unique contactIdentifier. BirthdayCalculator handles Feb 29 by mapping to March 1 in non-leap years and correctly computes days-until and sections. ContactBridge maps CNContact to Person with Gregorian/non-Gregorian birthday resolution, centralized keysToFetch, upsert, and stale removal. All logging is privacy-safe. Zero networking imports.
  </done>
</task>

</tasks>

<verification>
- Project structure follows the architecture from research exactly
- Person model uses decomposed Int fields, NOT DateComponents (research anti-pattern)
- BirthdayCalculator Feb 29 test: month=2, day=29 in a non-leap year returns March 1
- ContactBridge.keysToFetch() includes CNContactNonGregorianBirthdayKey and CNContactViewController.descriptorForRequiredKeys()
- App Group identifier "group.com.birthdayreminders" appears in both entitlements and ModelConfiguration
- Data Protection set to NSFileProtectionComplete
- `grep -r "import URL\|import Network\|URLSession" BirthdayReminders/` returns zero matches
- `grep -r "dependencies:" Package.swift` returns zero matches (no SPM packages)
</verification>

<success_criteria>
All data layer source files compile-ready with correct SwiftData model, pure birthday math with edge case handling, and CNContact mapping. Project configured with App Group and Data Protection from day one. Zero third-party dependencies. Zero networking imports.
</success_criteria>

<output>
After completion, create `.planning/phases/01-contact-import-and-birthday-list/01-01-SUMMARY.md`
</output>
