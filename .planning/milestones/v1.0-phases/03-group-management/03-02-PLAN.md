---
phase: 03-group-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - BirthdayReminders/Views/Groups/GroupListView.swift
  - BirthdayReminders/Views/Groups/GroupDetailView.swift
  - BirthdayReminders/Views/Groups/GroupMemberPickerView.swift
  - BirthdayReminders/Views/BirthdayList/BirthdayListView.swift
  - BirthdayReminders/Views/Components/SettingsPlaceholderView.swift
  - BirthdayReminders/App/BirthdayRemindersApp.swift
autonomous: true

must_haves:
  truths:
    - "User can see a list of all groups and create new groups from within the app"
    - "User can rename and delete existing groups"
    - "User can tap a group to see its members and change its notification preference"
    - "User can add and remove contacts from a group via a multi-select picker"
    - "Groups are accessible from the main birthday list screen"
    - "Notification rescheduling triggers after any group change that affects preferences"
  artifacts:
    - path: "BirthdayReminders/Views/Groups/GroupListView.swift"
      provides: "Group list with create, rename, delete, and navigation to detail"
      contains: "GroupListView"
    - path: "BirthdayReminders/Views/Groups/GroupDetailView.swift"
      provides: "Group detail with member list and notification preference picker"
      contains: "GroupDetailView"
    - path: "BirthdayReminders/Views/Groups/GroupMemberPickerView.swift"
      provides: "Multi-select contact picker for adding/removing group members"
      contains: "GroupMemberPickerView"
  key_links:
    - from: "BirthdayReminders/Views/BirthdayList/BirthdayListView.swift"
      to: "BirthdayReminders/Views/Groups/GroupListView.swift"
      via: "NavigationLink or toolbar button"
      pattern: "GroupListView"
    - from: "BirthdayReminders/Views/Groups/GroupDetailView.swift"
      to: "BirthdayReminders/Services/GroupSyncService.swift"
      via: "calls renameGroup, deleteGroup, notification preference mutation"
      pattern: "groupSyncService"
    - from: "BirthdayReminders/Views/Groups/GroupMemberPickerView.swift"
      to: "BirthdayReminders/Services/GroupSyncService.swift"
      via: "calls addMember/removeMember"
      pattern: "groupSyncService"
---

<objective>
Build the group management UI: group list (create/rename/delete), group detail (members + notification preference), member picker (add/remove contacts), and wire everything into the existing app navigation with post-change notification rescheduling.

Purpose: Makes group management accessible to the user. Plan 01 built the data and service layers; this plan delivers the screens the user interacts with. Without this, groups exist only as invisible data. This completes all four GRPS requirements.

Output: GroupListView.swift, GroupDetailView.swift, GroupMemberPickerView.swift, updated BirthdayListView with groups navigation, updated app wiring for GroupSyncService injection.
</objective>

<execution_context>
@C:/Users/bmbor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/bmbor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-group-management/03-RESEARCH.md
@.planning/phases/03-group-management/03-01-SUMMARY.md
@BirthdayReminders/Views/BirthdayList/BirthdayListView.swift
@BirthdayReminders/Views/Components/SettingsPlaceholderView.swift
@BirthdayReminders/App/BirthdayRemindersApp.swift
@BirthdayReminders/Models/BirthdayGroup.swift
@BirthdayReminders/Services/GroupSyncService.swift
@BirthdayReminders/Services/NotificationScheduler.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: GroupListView and GroupDetailView</name>
  <files>
    BirthdayReminders/Views/Groups/GroupListView.swift
    BirthdayReminders/Views/Groups/GroupDetailView.swift
  </files>
  <action>
    Create BirthdayReminders/Views/Groups/GroupListView.swift:
    - struct GroupListView with parameters: groupSyncService: GroupSyncService, notificationScheduler: NotificationScheduler
    - @Query(sort: \BirthdayGroup.name) private var groups: [BirthdayGroup]
    - @Environment(\.modelContext) private var modelContext
    - @State private var showingAddGroup = false
    - @State private var newGroupName = ""
    - NavigationStack with List of groups, each row showing group name and member count
    - Each row is a NavigationLink to GroupDetailView for that group
    - Swipe-to-delete on rows: calls groupSyncService.deleteGroup, then reschedules notifications
    - Toolbar button (plus icon) shows an alert with a TextField to enter group name
    - On alert confirm: call groupSyncService.createGroup(name:context:), handle errors with do/catch
    - Empty state: Text("No groups yet") with descriptive message when groups array is empty
    - .navigationTitle("Groups")
    - Wrap groupSyncService calls in do/catch, show error via @State alert if CNSaveRequest fails

    Create BirthdayReminders/Views/Groups/GroupDetailView.swift:
    - struct GroupDetailView with parameters: group: BirthdayGroup, groupSyncService: GroupSyncService, notificationScheduler: NotificationScheduler
    - @Environment(\.modelContext) private var modelContext
    - @Environment(\.dismiss) private var dismiss
    - @State private var isEditingName = false
    - @State private var editedName: String (initialized from group.name)
    - @State private var showingMemberPicker = false
    - List with sections:
      1. "Name" section: Text showing group name, with swipe or button to rename
         - Rename: shows alert with TextField, on confirm calls groupSyncService.renameGroup
      2. "Notification Preference" section: Picker (segmented or menu style) bound to group.notificationPreference
         - Uses @Bindable var group for direct binding
         - onChange of notificationPreference: trigger notification rescheduling
      3. "Members" section: ForEach over group.members sorted by displayName
         - Each row shows person.displayName and BirthdayCalculator.formattedBirthday
         - Swipe-to-delete on member rows: calls groupSyncService.removeMember, then reschedules
         - "Add Members" button at end of section (or toolbar): sets showingMemberPicker = true
    - .sheet(isPresented: $showingMemberPicker) presents GroupMemberPickerView
    - Delete group: toolbar or button that calls groupSyncService.deleteGroup then dismiss()
    - .navigationTitle(group.name)

    For notification rescheduling after group changes, create a private helper in both views:
    ```
    private func rescheduleNotifications() async {
        let descriptor = FetchDescriptor<Person>()
        guard let people = try? modelContext.fetch(descriptor) else { return }
        let hour = UserDefaults.standard.object(forKey: "notificationHour") as? Int ?? 9
        let minute = UserDefaults.standard.object(forKey: "notificationMinute") as? Int ?? 0
        await notificationScheduler.reschedule(people: people, deliveryHour: hour, deliveryMinute: minute)
    }
    ```

    This follows the existing pattern from SettingsView.rescheduleAfterImport().
  </action>
  <verify>
    Both files exist at expected paths. GroupListView has @Query for groups, add/delete functionality, and NavigationLink to GroupDetailView. GroupDetailView has rename, notification preference picker, member list with remove, and add members sheet trigger.
  </verify>
  <done>
    GroupListView displays all groups with create and delete. GroupDetailView shows group name (renameable), notification preference picker, and member list with remove capability. Both views trigger notification rescheduling after changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: GroupMemberPickerView, app navigation wiring, and GroupSyncService injection</name>
  <files>
    BirthdayReminders/Views/Groups/GroupMemberPickerView.swift
    BirthdayReminders/Views/BirthdayList/BirthdayListView.swift
    BirthdayReminders/Views/Components/SettingsPlaceholderView.swift
    BirthdayReminders/App/BirthdayRemindersApp.swift
  </files>
  <action>
    Create BirthdayReminders/Views/Groups/GroupMemberPickerView.swift:
    - struct GroupMemberPickerView with parameters: group: BirthdayGroup, groupSyncService: GroupSyncService, notificationScheduler: NotificationScheduler
    - @Query(sort: \Person.firstName) private var allPeople: [Person]
    - @Environment(\.modelContext) private var modelContext
    - @Environment(\.dismiss) private var dismiss
    - @State private var selectedIdentifiers: Set<String> (initialized from group.members contactIdentifiers)
    - Computed: currentMemberIdentifiers = Set(group.members.map(\.contactIdentifier))
    - NavigationStack with List of all people
    - Each row shows person.displayName with a checkmark (Image(systemName: "checkmark")) if person is in selectedIdentifiers
    - Tapping a row toggles membership:
      - If currently in group: call groupSyncService.removeMember, remove from selectedIdentifiers
      - If not in group: call groupSyncService.addMember, add to selectedIdentifiers
    - Wrap each add/remove in do/catch for CNSaveRequest error handling
    - Search bar (.searchable) to filter contacts by name
    - Toolbar done button that dismisses and triggers notification rescheduling
    - .navigationTitle("Add Members")
    - Use the same rescheduleNotifications() private helper pattern

    Modify BirthdayReminders/Views/BirthdayList/BirthdayListView.swift:
    - Add groupSyncService: GroupSyncService parameter alongside existing syncService and notificationScheduler
    - Add a toolbar button (people.3 icon) or NavigationLink in the toolbar that navigates to GroupListView
    - Pass groupSyncService and notificationScheduler to GroupListView
    - Keep all existing functionality (search, sections, settings navigation) unchanged

    Modify BirthdayReminders/Views/Components/SettingsPlaceholderView.swift (SettingsView):
    - No structural changes needed unless group sync should be explicitly triggerable from settings
    - The group sync already runs during contact re-import via ContactSyncService integration from Plan 01

    Modify BirthdayReminders/App/BirthdayRemindersApp.swift:
    - Add `private let groupSyncService = GroupSyncService()` alongside existing services
    - Wire groupSyncService into ContactSyncService: in the .task modifier, set syncService.groupSyncService = groupSyncService
    - Pass groupSyncService to BirthdayListView: BirthdayListView(syncService: syncService, notificationScheduler: notificationScheduler, groupSyncService: groupSyncService)
    - Pass groupSyncService to OnboardingFlowView if needed, or groups are only accessible post-onboarding (which is the case -- groups tab is in BirthdayListView)
  </action>
  <verify>
    GroupMemberPickerView exists with multi-select toggle for contacts. BirthdayListView has groups navigation button and passes groupSyncService. BirthdayRemindersApp creates GroupSyncService and wires it to both ContactSyncService and BirthdayListView. App builds with no missing parameters.
  </verify>
  <done>
    GroupMemberPickerView provides toggle-based multi-select for adding/removing contacts from groups. BirthdayListView toolbar includes groups navigation. App root creates and injects GroupSyncService everywhere needed. Full group management flow is navigable: birthday list -> groups -> group detail -> member picker.
  </done>
</task>

</tasks>

<verification>
1. GroupListView shows all groups, supports create (alert + text field) and delete (swipe)
2. GroupDetailView shows name (renameable), notification preference picker, and member list (with remove)
3. GroupMemberPickerView allows multi-select add/remove of contacts from a group
4. BirthdayListView toolbar has a groups navigation entry
5. BirthdayRemindersApp creates GroupSyncService and injects it into ContactSyncService and views
6. Notification rescheduling triggers after group delete, member add/remove, and preference change
7. All navigation flows work: birthday list -> groups -> group detail -> member picker
</verification>

<success_criteria>
- User can navigate to groups from the birthday list screen
- User can create a new group by name
- User can rename and delete groups
- User can see group members and their birthday info
- User can add/remove contacts via a multi-select picker
- User can change a group's notification preference (day of, day before, both)
- All group changes trigger notification rescheduling
- Complete navigation flow works end to end
</success_criteria>

<output>
After completion, create `.planning/phases/03-group-management/03-02-SUMMARY.md`
</output>
