---
phase: 04-widgets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - project.yml
  - BirthdayReminders/App/BirthdayRemindersApp.swift
  - BirthdayRemindersWidget/Info.plist
  - BirthdayRemindersWidget/BirthdayRemindersWidget.entitlements
  - BirthdayRemindersWidget/Provider/BirthdayTimelineEntry.swift
  - BirthdayRemindersWidget/Provider/BirthdayTimelineProvider.swift
autonomous: true

must_haves:
  truths:
    - "Widget extension target exists in project.yml with correct app-extension type and shared source files"
    - "Widget extension has its own entitlements with the same app group (group.com.birthdayreminders)"
    - "TimelineProvider fetches upcoming birthdays from the shared SwiftData store and produces timeline entries"
    - "Main app triggers WidgetCenter.shared.reloadAllTimelines() after every contact sync"
  artifacts:
    - path: "project.yml"
      provides: "BirthdayRemindersWidget target configuration"
      contains: "BirthdayRemindersWidget"
    - path: "BirthdayRemindersWidget/Info.plist"
      provides: "Widget extension NSExtension configuration"
      contains: "com.apple.widgetkit-extension"
    - path: "BirthdayRemindersWidget/BirthdayRemindersWidget.entitlements"
      provides: "App group entitlement for widget extension"
      contains: "group.com.birthdayreminders"
    - path: "BirthdayRemindersWidget/Provider/BirthdayTimelineEntry.swift"
      provides: "TimelineEntry and WidgetBirthday value types"
      contains: "struct BirthdayTimelineEntry"
    - path: "BirthdayRemindersWidget/Provider/BirthdayTimelineProvider.swift"
      provides: "TimelineProvider with SwiftData query"
      contains: "struct BirthdayTimelineProvider"
    - path: "BirthdayReminders/App/BirthdayRemindersApp.swift"
      provides: "WidgetCenter reload after data changes"
      contains: "reloadAllTimelines"
  key_links:
    - from: "BirthdayRemindersWidget/Provider/BirthdayTimelineProvider.swift"
      to: "BirthdayReminders/Models/Person.swift"
      via: "SwiftData FetchDescriptor in shared app group container"
      pattern: "FetchDescriptor<Person>"
    - from: "BirthdayReminders/App/BirthdayRemindersApp.swift"
      to: "WidgetKit"
      via: "WidgetCenter.shared.reloadAllTimelines()"
      pattern: "reloadAllTimelines"
    - from: "project.yml"
      to: "BirthdayRemindersWidget"
      via: "XcodeGen widget extension target with shared sources"
      pattern: "type: app-extension"
---

<objective>
Set up the WidgetKit extension target with XcodeGen, create the timeline data layer (TimelineProvider, TimelineEntry, WidgetBirthday), and wire the main app to trigger widget refreshes after data changes.

Purpose: Establish the widget extension infrastructure and data pipeline so widget views (Plan 04-02) can render upcoming birthdays from the shared SwiftData store.
Output: Compilable widget extension target with timeline provider that reads from the shared app group database.
</objective>

<execution_context>
@C:/Users/bmbor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/bmbor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-widgets/04-RESEARCH.md
@.planning/phases/01-contact-import-and-birthday-list/01-01-SUMMARY.md

Key existing files:
@project.yml
@BirthdayReminders/App/BirthdayRemindersApp.swift
@BirthdayReminders/Models/Person.swift
@BirthdayReminders/Models/BirthdayGroup.swift
@BirthdayReminders/Services/BirthdayCalculator.swift
@BirthdayReminders/Extensions/Date+Birthday.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget extension target configuration and support files</name>
  <files>
    project.yml
    BirthdayRemindersWidget/Info.plist
    BirthdayRemindersWidget/BirthdayRemindersWidget.entitlements
  </files>
  <action>
1. Create directory `BirthdayRemindersWidget/Provider/` and `BirthdayRemindersWidget/Views/HomeScreen/` and `BirthdayRemindersWidget/Views/LockScreen/`.

2. Create `BirthdayRemindersWidget/Info.plist` with NSExtension dictionary:
   - NSExtensionPointIdentifier: com.apple.widgetkit-extension
   - Standard bundle keys (CFBundleDevelopmentRegion, CFBundleDisplayName "Birthday Widgets", CFBundleExecutable, CFBundleIdentifier, CFBundleInfoDictionaryVersion "6.0", CFBundleName, CFBundlePackageType, CFBundleShortVersionString "1.0", CFBundleVersion "1")
   - Use exact XML format from research (Pattern: Widget Extension Info.plist section).

3. Create `BirthdayRemindersWidget/BirthdayRemindersWidget.entitlements` with app group:
   - com.apple.security.application-groups array containing "group.com.birthdayreminders"
   - Use exact XML format from research (Pattern: Widget Extension Entitlements section).

4. Update `project.yml` to add the BirthdayRemindersWidget target:
   - Add a new target `BirthdayRemindersWidget` with `type: app-extension`, `platform: iOS`, `deploymentTarget: "18.0"`
   - Sources: `BirthdayRemindersWidget` directory PLUS shared files from main app:
     - `BirthdayReminders/Models/Person.swift`
     - `BirthdayReminders/Models/BirthdayGroup.swift`
     - `BirthdayReminders/Services/BirthdayCalculator.swift`
     - `BirthdayReminders/Extensions/Date+Birthday.swift`
   - Settings base: PRODUCT_BUNDLE_IDENTIFIER `com.birthdayreminders.widget`, INFOPLIST_FILE, CODE_SIGN_ENTITLEMENTS, SWIFT_VERSION "6.0", SKIP_INSTALL true, ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME AccentColor, ASSETCATALOG_COMPILER_WIDGET_BACKGROUND_COLOR_NAME WidgetBackground, TARGETED_DEVICE_FAMILY "1", GENERATE_INFOPLIST_FILE false
   - Entitlements path with app group property
   - Framework dependencies: SwiftUI.framework, WidgetKit.framework (via sdk entries)
   - Add `- target: BirthdayRemindersWidget` to the existing BirthdayReminders target's dependencies section (create dependencies key if absent)
   - See research XcodeGen section for exact YAML structure.

IMPORTANT: The existing BirthdayReminders target has NO dependencies key. Add it as a new key under the target.
  </action>
  <verify>
    Verify project.yml has both targets (BirthdayReminders and BirthdayRemindersWidget). Verify Info.plist contains "com.apple.widgetkit-extension". Verify entitlements contains "group.com.birthdayreminders".
  </verify>
  <done>
    Widget extension target is configured in project.yml with shared source files, correct bundle ID, entitlements, and Info.plist. Main app target lists widget as a dependency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create timeline data layer and wire main app widget reload</name>
  <files>
    BirthdayRemindersWidget/Provider/BirthdayTimelineEntry.swift
    BirthdayRemindersWidget/Provider/BirthdayTimelineProvider.swift
    BirthdayReminders/App/BirthdayRemindersApp.swift
  </files>
  <action>
1. Create `BirthdayRemindersWidget/Provider/BirthdayTimelineEntry.swift`:
   - `struct WidgetBirthday: Identifiable` with `id = UUID()`, `name: String`, `daysUntil: Int`, `month: Int`, `day: Int`, `year: Int?`
   - Computed property `daysUntilText: String` returning "Today" for 0, "Tomorrow" for 1, "in X days" otherwise
   - `struct BirthdayTimelineEntry: TimelineEntry` with `date: Date`, `upcomingBirthdays: [WidgetBirthday]`
   - Static `placeholder` property returning sample data (3 entries with realistic names and varying daysUntil values: 0, 3, 7)
   - Import WidgetKit for TimelineEntry protocol.

2. Create `BirthdayRemindersWidget/Provider/BirthdayTimelineProvider.swift`:
   - `struct BirthdayTimelineProvider: TimelineProvider` with `typealias Entry = BirthdayTimelineEntry`
   - Private computed property `sharedModelContainer: ModelContainer` that creates a ModelContainer with Schema([Person.self, BirthdayGroup.self]), ModelConfiguration named "BirthdayReminders" with `groupContainer: .identifier("group.com.birthdayreminders")` and `isStoredInMemoryOnly: false`. Use do/catch with fatalError on failure.
   - `placeholder(in:)` returns `BirthdayTimelineEntry.placeholder`
   - `getSnapshot(in:completion:)` calls `fetchEntry()` and passes to completion
   - `getTimeline(in:completion:)` calls `fetchEntry()`, computes midnight tomorrow via `Calendar.current.startOfDay(for: Calendar.current.date(byAdding: .day, value: 1, to: .now)!)`, creates Timeline with `.after(midnight)` policy
   - `@MainActor private func fetchEntry() -> BirthdayTimelineEntry` that creates the sharedModelContainer, fetches all Person via FetchDescriptor<Person>(), sorts by `daysUntilBirthday`, maps the first 8 to WidgetBirthday structs, returns a BirthdayTimelineEntry with current date and the mapped birthdays. Handle empty result gracefully (empty array).
   - Import WidgetKit, SwiftUI, SwiftData.
   - IMPORTANT: For Swift 6 strict concurrency, use `@preconcurrency import WidgetKit` if needed. Mark the provider struct with `@MainActor` if completion handler isolation causes issues -- but try without first.

3. Modify `BirthdayReminders/App/BirthdayRemindersApp.swift`:
   - Add `import WidgetKit` at top
   - In the existing `onImportComplete` closure (inside the `.task` modifier), add `WidgetCenter.shared.reloadAllTimelines()` AFTER the `notificationScheduler.reschedule(...)` await call
   - In the existing `.onChange(of: scenePhase)` handler for `.active`, add `WidgetCenter.shared.reloadAllTimelines()` AFTER the `notificationScheduler.reschedule(...)` await call
   - This ensures widgets refresh after every contact import and every app foreground
  </action>
  <verify>
    Verify BirthdayTimelineEntry.swift defines both WidgetBirthday and BirthdayTimelineEntry structs. Verify BirthdayTimelineProvider.swift implements all three TimelineProvider methods (placeholder, getSnapshot, getTimeline). Verify BirthdayRemindersApp.swift contains "import WidgetKit" and "reloadAllTimelines".
  </verify>
  <done>
    TimelineProvider fetches upcoming birthdays from the shared SwiftData store via app group container. Timeline refreshes at midnight daily. Main app triggers widget reload after every contact sync and on each foreground entry.
  </done>
</task>

</tasks>

<verification>
- project.yml defines BirthdayRemindersWidget target with type: app-extension and shared source files
- Widget Info.plist has NSExtensionPointIdentifier = com.apple.widgetkit-extension
- Widget entitlements has group.com.birthdayreminders app group
- BirthdayTimelineProvider creates ModelContainer with same app group as main app
- BirthdayTimelineProvider.getTimeline uses .after(midnight) refresh policy
- BirthdayRemindersApp.swift calls WidgetCenter.shared.reloadAllTimelines() after sync
- No networking code, no third-party imports (SECR-01, SECR-03)
</verification>

<success_criteria>
Widget extension target is fully configured in XcodeGen with shared source files. Timeline provider reads from the shared SwiftData store and produces entries sorted by days-until-birthday. Main app triggers widget refresh after every data change.
</success_criteria>

<output>
After completion, create `.planning/phases/04-widgets/04-01-SUMMARY.md`
</output>
