---
phase: 01-contact-import-and-birthday-list
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - BirthdayReminders/Services/ContactSyncService.swift
  - BirthdayReminders/Views/Onboarding/WelcomeView.swift
  - BirthdayReminders/Views/Onboarding/PermissionRequestView.swift
  - BirthdayReminders/Views/Onboarding/ImportProgressView.swift
  - BirthdayReminders/Views/Onboarding/PermissionDeniedView.swift
  - BirthdayReminders/Views/Onboarding/OnboardingFlowView.swift
  - BirthdayReminders/App/BirthdayRemindersApp.swift
autonomous: true

must_haves:
  truths:
    - "User sees a guided onboarding on first launch: welcome screen, then permission request, then import"
    - "User can grant contact permission and import all contacts with birthdays in one tap (IMPT-01)"
    - "App requests contact access permission with contextual explanation before sync (IMPT-02)"
    - "If permission denied, user sees friendly explanation of why access is needed and a link to open Settings"
    - "Contacts without birthdays are silently ignored during import"
    - "Re-import is available via a manual button (no continuous sync)"
    - "Import removes stale contacts no longer in the Contacts store"
  artifacts:
    - path: "BirthdayReminders/Services/ContactSyncService.swift"
      provides: "CNContactStore wrapper with all five auth states, async import, progress tracking"
      contains: "ContactSyncService"
    - path: "BirthdayReminders/Views/Onboarding/OnboardingFlowView.swift"
      provides: "State machine driving welcome -> permission -> import -> complete/denied flow"
      contains: "OnboardingStep"
    - path: "BirthdayReminders/Views/Onboarding/WelcomeView.swift"
      provides: "First-launch welcome screen explaining the app"
      contains: "WelcomeView"
    - path: "BirthdayReminders/Views/Onboarding/PermissionRequestView.swift"
      provides: "Pre-permission screen with contextual explanation"
      contains: "PermissionRequestView"
    - path: "BirthdayReminders/Views/Onboarding/PermissionDeniedView.swift"
      provides: "Friendly explanation + Open Settings link when permission denied"
      contains: "UIApplication.openSettingsURLString"
    - path: "BirthdayReminders/Views/Onboarding/ImportProgressView.swift"
      provides: "Import progress with indeterminate ProgressView"
      contains: "ProgressView"
  key_links:
    - from: "BirthdayReminders/Services/ContactSyncService.swift"
      to: "BirthdayReminders/Models/ContactBridge.swift"
      via: "Calls ContactBridge.keysToFetch(), .upsert(), .removeStale()"
      pattern: "ContactBridge\\."
    - from: "BirthdayReminders/Views/Onboarding/OnboardingFlowView.swift"
      to: "BirthdayReminders/Services/ContactSyncService.swift"
      via: "Calls requestAccess() and importContacts() to drive onboarding"
      pattern: "syncService\\.(requestAccess|importContacts|checkAuthorizationStatus)"
    - from: "BirthdayReminders/App/BirthdayRemindersApp.swift"
      to: "BirthdayReminders/Views/Onboarding/OnboardingFlowView.swift"
      via: "Root view shows onboarding or main list based on hasCompletedOnboarding"
      pattern: "hasCompletedOnboarding"
---

<objective>
Implement the ContactSyncService (authorization handling + contact import) and the complete onboarding flow UI (welcome, permission request, import progress, permission denied). Wire the app entry point to show onboarding on first launch and the birthday list after completion.

Purpose: This plan delivers the core import experience -- the user's first interaction with the app. It bridges the data layer (Plan 01) with the UI by providing the service that reads contacts and the onboarding views that guide the user through permission granting and import.
Output: Working onboarding flow that imports contacts into SwiftData on first launch.
</objective>

<execution_context>
@C:/Users/bmbor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/bmbor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contact-import-and-birthday-list/01-CONTEXT.md
@.planning/phases/01-contact-import-and-birthday-list/01-RESEARCH.md
@.planning/phases/01-contact-import-and-birthday-list/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ContactSyncService with full authorization handling and async import</name>
  <files>
    BirthdayReminders/Services/ContactSyncService.swift
  </files>
  <action>
    Create ContactSyncService as an @Observable @MainActor class per research Pattern 3.

    **Authorization state model:**
    - Define `enum ContactAuthState` with cases: notDetermined, authorized, limited, denied, restricted
    - All five CNAuthorizationStatus cases must be mapped, including iOS 18 `.limited`
    - Use `@unknown default` mapped to `.denied` for future-proofing

    **Properties (all private(set)):**
    - `authState: ContactAuthState = .notDetermined`
    - `isImporting: Bool = false`
    - `importedCount: Int = 0`
    - `error: Error? = nil`

    **Methods:**

    1. `func checkAuthorizationStatus()` -- Read current CNContactStore.authorizationStatus(for: .contacts) and map to ContactAuthState. Call this on service init and whenever the app returns to foreground.

    2. `func requestAccess() async -> Bool` -- Call `store.requestAccess(for: .contacts)` with try/await. Update authState afterward via checkAuthorizationStatus(). Return whether access was granted. Catch errors and set self.error.

    3. `func importContacts(into context: ModelContext) async` -- Per research Pattern 3:
       - Set isImporting = true, importedCount = 0
       - Build CNContactFetchRequest with ContactBridge.keysToFetch()
       - Run `store.enumerateContacts(with:)` in `Task.detached` to avoid blocking main thread
       - Filter: only contacts where `contact.birthday != nil || contact.nonGregorianBirthday != nil`
       - Collect matching CNContact array
       - Back on main actor: loop through contacts, call `ContactBridge.upsert(from:into:)` for each, increment importedCount
       - Call `ContactBridge.removeStale(knownIdentifiers:context:)` with the set of imported identifiers
       - Call `try? context.save()`
       - Set isImporting = false in defer block
       - Log import count via Logger.sync (count is safe to log; names are not)

    **For .limited authorization:** Treat the same as .authorized -- the user selected a subset and the app imports what it can access. The import flow works identically; CNContactStore only returns the contacts the user shared.

    IMPORTANT: Do NOT import URLSession or Network (SECR-01).
    IMPORTANT: Use Logger.sync with `privacy: .private` for any contact-related string data (SECR-04).
    IMPORTANT: The store property should be `private let store = CNContactStore()` -- do not create multiple instances.
  </action>
  <verify>
    - ContactSyncService.swift exists with @Observable @MainActor class
    - All five CNAuthorizationStatus cases handled in checkAuthorizationStatus()
    - requestAccess() uses async/await
    - importContacts() runs enumeration in Task.detached, calls ContactBridge.upsert and .removeStale
    - .limited case is handled (mapped to authState, import works)
    - Logger.sync used with privacy: .private for contact data
    - No URLSession or Network imports
  </verify>
  <done>
    ContactSyncService handles all five authorization states including iOS 18 .limited, imports contacts asynchronously without blocking the main thread, upserts via ContactBridge, removes stale contacts, and logs safely.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build onboarding flow views and wire app entry point</name>
  <files>
    BirthdayReminders/Views/Onboarding/WelcomeView.swift
    BirthdayReminders/Views/Onboarding/PermissionRequestView.swift
    BirthdayReminders/Views/Onboarding/ImportProgressView.swift
    BirthdayReminders/Views/Onboarding/PermissionDeniedView.swift
    BirthdayReminders/Views/Onboarding/OnboardingFlowView.swift
    BirthdayReminders/App/BirthdayRemindersApp.swift
  </files>
  <action>
    **Onboarding state machine (in OnboardingFlowView.swift):**

    Define `enum OnboardingStep: Equatable` with cases: welcome, permissionRequest, importing, complete, permissionDenied

    Create OnboardingFlowView as the container view that:
    - Holds `@State private var step: OnboardingStep = .welcome`
    - Receives ContactSyncService from environment or as parameter
    - Uses a switch on `step` to show the appropriate sub-view
    - Manages transitions between steps based on user actions and service state
    - Stores completion in `@AppStorage("hasCompletedOnboarding") private var hasCompletedOnboarding = false`

    **WelcomeView.swift:**
    - Clean, friendly welcome screen explaining the app purpose
    - App name "Birthday Reminders" prominently displayed
    - Brief explanation: "Never miss a birthday. Import your contacts and see upcoming birthdays at a glance."
    - A large, prominent "Get Started" button
    - iOS-native feel: system fonts, standard controls (user decision)
    - On tap: callback/closure that advances to permissionRequest step
    - Light and dark mode compatible (user decision: follow system setting)

    **PermissionRequestView.swift:**
    - Pre-permission screen explaining WHY the app needs contact access (IMPT-02)
    - Contextual explanation: "Birthday Reminders reads your contacts to find birthdays. Your data stays on this device and is never shared." (reinforces SECR-01/SECR-02 promise)
    - A prominent "Allow Access" button that triggers the actual system permission dialog
    - On allow: call `syncService.requestAccess()`. If granted (.authorized or .limited), advance to importing step. If denied, advance to permissionDenied step.
    - iOS-native feel with system blue accent (user decision)

    **ImportProgressView.swift:**
    - Shows an indeterminate ProgressView (spinner) with text "Importing contacts..." (discretion: research recommends indeterminate since import is < 3 seconds)
    - Optionally shows importedCount as it updates ("Found X birthdays...")
    - Triggers `syncService.importContacts(into: context)` on appear
    - On completion (isImporting becomes false): set hasCompletedOnboarding = true and advance to complete step

    **PermissionDeniedView.swift:**
    - Friendly, non-accusatory explanation: "Birthday Reminders needs access to your contacts to find birthdays."
    - Explains what to do: "You can grant access in Settings."
    - "Open Settings" button that calls `UIApplication.shared.open(URL(string: UIApplication.openSettingsURLString)!)`
    - "Try Again" button that re-checks authorization status (user may have changed it in Settings)
    - Matches iOS-native feel (user decision)

    **Update BirthdayRemindersApp.swift:**
    - Replace placeholder ContentView with routing logic:
      - Read `@AppStorage("hasCompletedOnboarding")` boolean
      - If false: show OnboardingFlowView
      - If true: show BirthdayListView (placeholder NavigationStack with Text("Birthday List") for now -- Plan 03 builds the real list)
    - Pass the ModelContainer's modelContext to the onboarding flow
    - Create ContactSyncService as @State and inject it into the environment or pass directly

    IMPORTANT: All views must support light AND dark mode via system colors (user decision). Do NOT hardcode colors.
    IMPORTANT: Use system blue accent color -- default iOS tint (user decision).
    IMPORTANT: No tab bar -- single screen with navigation bar (user decision).
    IMPORTANT: Do NOT add age, photos, zodiac, or any extras to any view (user decisions: minimal, basics only).
  </action>
  <verify>
    - All five onboarding view files exist
    - OnboardingFlowView contains OnboardingStep enum with all five cases and switch-based routing
    - WelcomeView has a "Get Started" button
    - PermissionRequestView explains why access is needed and has "Allow Access" button
    - ImportProgressView shows ProgressView and triggers importContacts
    - PermissionDeniedView has "Open Settings" button with UIApplication.openSettingsURLString
    - BirthdayRemindersApp.swift routes based on hasCompletedOnboarding
    - No hardcoded colors (uses system colors for light/dark mode)
    - No tab bar in any view
    - No age, photos, zodiac in any view
  </verify>
  <done>
    Complete onboarding flow: welcome screen with app explanation, pre-permission screen with contextual justification, import with progress indicator, and permission-denied recovery with Settings link. App entry point routes between onboarding and birthday list based on completion state. All views follow iOS-native design with system colors and light/dark mode support.
  </done>
</task>

</tasks>

<verification>
- ContactSyncService handles .notDetermined, .authorized, .limited, .denied, .restricted
- Onboarding flow: welcome -> permission -> import -> complete (happy path)
- Onboarding flow: welcome -> permission -> denied (denied path)
- Permission denied view offers "Open Settings" link and "Try Again"
- Import calls ContactBridge.upsert and .removeStale
- BirthdayRemindersApp routes to onboarding when hasCompletedOnboarding is false
- BirthdayRemindersApp routes to list placeholder when hasCompletedOnboarding is true
- All views use system colors (no hardcoded light/dark colors)
- `grep -r "import URL\|import Network\|URLSession" BirthdayReminders/` returns zero matches
</verification>

<success_criteria>
User can launch the app, see a welcome screen, grant contact permission with contextual explanation, import contacts with progress feedback, and arrive at the main screen. Permission denied scenario shows recovery path. ContactSyncService correctly imports contacts with birthdays, ignores contacts without, and removes stale entries. All five authorization states handled.
</success_criteria>

<output>
After completion, create `.planning/phases/01-contact-import-and-birthday-list/01-02-SUMMARY.md`
</output>
